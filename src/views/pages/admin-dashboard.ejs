<%- include('../partials/header') %>

<div class="flex min-h-screen bg-gray-100">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-white flex-shrink-0 hidden md:block">
        <div class="p-6">
            <h2 class="text-lg font-bold tracking-wider">ADMIN PORTAL</h2>
        </div>
        <nav class="mt-6 px-4 space-y-2">
            <a href="/admin/dashboard" class="block px-4 py-3 bg-blue-600 rounded-lg text-sm font-medium">Dashboard</a>
            <a href="/" class="block px-4 py-3 text-gray-400 hover:text-white rounded-lg text-sm transition">Back to Store</a>
            <a href="/admin/logout" class="block px-4 py-3 text-red-400 hover:text-red-200 hover:bg-red-900/20 rounded-lg text-sm transition mt-8 border border-red-900/30">Logout</a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Dashboard Overview</h1>
            <div class="text-sm text-gray-500">Welcome, Admin</div>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Total Products</div>
                <div class="text-3xl font-bold text-gray-900"><%= topProducts.length %></div>
            </div>
             <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Unique Visitors</div>
                <div class="text-3xl font-bold text-purple-600"><%= totalVisitors || 0 %></div>
            </div>
             <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">ETL Status</div>
                <div class="text-lg font-semibold text-green-600">Active</div>
            </div>
        </div>

        <!-- ETL Control & Reset -->
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold text-gray-900">Data Engineering Pipeline</h3>
                <p class="text-gray-500 text-sm mt-1">Manage Log Ingestion and Processing.</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="resetData()" class="px-6 py-3 bg-red-100 text-red-600 rounded-xl font-medium hover:bg-red-200 transition">
                    Reset Analytics
                </button>
                <button id="runEtlBtn" onclick="runETL()" class="px-6 py-3 bg-indigo-600 text-white rounded-xl font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Trigger ETL Job</span>
                </button>
            </div>
        </div>

        <!-- Analytics Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Daily Trend Chart -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Traffic Trend (Last 24h)</h3>
                <div class="relative h-64 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Top Products Chart -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Most Viewed Products</h3>
                <div class="relative h-64 w-full">
                    <canvas id="productChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Recent Visitors Table -->
            <div class="lg:col-span-1 bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Visitors</h3>
                 <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-100 text-xs uppercase">
                                <th class="pb-3 font-medium">Session ID (Who)</th>
                                <th class="pb-3 font-medium text-right">Last Seen</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm text-gray-600">
                            <% if (recentVisitors && recentVisitors.length > 0) { %>
                                <% recentVisitors.forEach(v => { %>
                                <tr class="border-b border-gray-50 last:border-0">
                                    <td class="py-3 font-mono text-xs text-blue-600 truncate max-w-[100px]" title="<%= v.user_agent %>">
                                        <%= v.session_id.substring(0, 12) %>...
                                    </td>
                                    <td class="py-3 text-right">
                                        <% 
                                            // Manual Shift: UTC + 7 Hours
                                            const d = new Date(new Date(v.last_seen).getTime() + (7 * 3600000));
                                            // 1. Time (HH:mm) - using ISO to grab the shifted time safely
                                            const timeStr = d.toISOString().substring(11, 16);
                                            // 2. Day & Date (Indonesian) - using UTC timezone because 'd' is already shifted
                                            const dayStr = d.toLocaleDateString('id-ID', { timeZone: 'UTC', weekday: 'long' });
                                            const dateStr = d.toLocaleDateString('id-ID', { timeZone: 'UTC', day: 'numeric', month: 'long', year: 'numeric' });
                                        %>
                                        <%= timeStr %> WIB / <%= dayStr %> / <%= dateStr %>
                                    </td>
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr><td colspan="2" class="py-4 text-center text-gray-400 text-xs">No active visitors.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Products Table -->
            <div class="lg:col-span-2 bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Performance Metrics</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 border-b border-gray-100">
                                <th class="pb-3 font-medium">Product Name</th>
                                <th class="pb-3 font-medium">Price</th>
                                <th class="pb-3 font-medium">Views</th>
                                <th class="pb-3 font-medium">Carts</th>
                                <th class="pb-3 font-medium">Purchases</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600">
                            <% if (topProducts && topProducts.length > 0) { %>
                                <% topProducts.forEach(product => { %>
                                <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50 transition">
                                    <td class="py-4 font-medium text-gray-900"><%= product.name %></td>
                                    <td class="py-4">Rp <%= product.price.toLocaleString('id-ID') %></td>
                                    <td class="py-4 font-bold text-blue-600"><%= product.view_count %></td>
                                    <td class="py-4 font-bold text-yellow-600"><%= product.cart_count %></td>
                                    <td class="py-4 font-bold text-green-600"><%= product.purchase_count %></td>
                                    
                                </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="py-8 text-center text-gray-400">No analytics data available yet. Run ETL Job.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Data Injection
    const productData = <%- JSON.stringify(topProducts || []) %>;
    const trendData = <%- JSON.stringify(dailyTrends || []) %>;

    // 1. Product Bar Chart
    const ctxProd = document.getElementById('productChart').getContext('2d');
    new Chart(ctxProd, {
        type: 'bar',
        data: {
            labels: productData.map(p => p.name.substring(0, 15) + '...'), // Truncate name
            datasets: [{
                label: 'Views',
                data: productData.map(p => p.view_count),
                backgroundColor: 'rgba(79, 70, 229, 0.6)',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    // 2. Trend Line Chart
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    // Format label: HH:00
    const trendLabels = trendData.map(d => `${d.hour}:00`); 
    const trendValues = trendData.map(d => d.total_views);

    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Total Views',
                data: trendValues,
                borderColor: 'rgba(16, 185, 129, 1)', // Emerald-500
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4, // Smooth curve
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
             plugins: { legend: { display: false } },
             scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
    });

    // Functions
    async function runETL() {
        const btn = document.getElementById('runEtlBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Processing...';
        btn.disabled = true;
        try {
            const res = await fetch('/admin/run-etl', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert(`Success! Processed: ${data.data.processed} items.`);
                window.location.reload();
            } else {
                alert('Failed.');
            }
        } catch (e) { alert('Error'); } 
        finally { btn.innerHTML = originalText; btn.disabled = false; }
    }

    async function resetData() {
        if (!confirm('Are you sure? This will zero out all analytics.')) return;
        try {
            const res = await fetch('/admin/reset-data', { method: 'POST' });
            if (res.ok) window.location.reload();
        } catch (e) { alert('Error resetting data'); }
    }
</script>
</body>
</html>
